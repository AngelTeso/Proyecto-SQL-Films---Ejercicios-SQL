# README — Proyecto SQL (PostgreSQL) | Pasos y análisis

## 1) Contexto
Trabajo de exploración y análisis de una BBDD tipo videoclub (tablas principales: `film`, `actor`, `customer`, `rental`, `payment`, `inventory`, `category` y tablas puente `film_actor`, `film_category`).  
Objetivo: practicar SQL en PostgreSQL (filtros, agregaciones, subconsultas, joins, CTEs, temporales, vistas y funciones de fecha/estadística).

> Atención: el script incluye sentencias que **modifican el esquema** (ALTER TABLE) y crean **vistas** y **tablas temporales**.

---

## 2) Ejecución segura (recomendación)
1) Ejecutar primero las consultas de lectura (`SELECT`) para validar resultados.  
2) Ejecutar al final el bloque de cambios/objetos:
- `ALTER TABLE actor RENAME COLUMN ...`
- `ALTER TABLE rental ADD COLUMN ...` + `UPDATE`
- `CREATE TEMP TABLE ...`
- `CREATE VIEW ...`

**Reversión rápida**
- TEMP TABLE: se borran al cerrar la sesión.
- VIEW: persisten hasta `DROP VIEW`.
- ALTER TABLE: cambio permanente.

---

## 3) Pasos seguidos durante el proyecto (resumen por bloques)

### 0. Exploración del esquema y datos
- Revisión del contenido de: `CUSTOMER`, `FILM`, `film_category`, `category`, `inventory`, `rental`, `payment`, `actor`, `film_actor`, `language`, `store`, `staff`.
- Objetivo: entender claves y relaciones antes de escribir consultas.

### 1. Filtros y ordenación (WHERE / ORDER BY)
- Películas por rating (`R`, `PG-13`), por duración (>= 180) y exclusiones con `NOT IN`.
- Actores por rango de `actor_id` (30–40) y búsqueda por apellido con `LIKE`.
- Ordenaciones por duración y por apellido (asc/desc).
- Paginación con `LIMIT` y `OFFSET`.

### 2. Agregaciones (GROUP BY) y métricas
- Conteo de películas por clasificación (`COUNT(*) GROUP BY rating`).
- Promedio de duración por clasificación (`AVG(length) GROUP BY rating`).
- Máxima y mínima duración (`MAX/MIN`).
- Total facturado (`SUM(amount)` en `payment`).
- Rankings: 10 clientes con mayor `customer_id` y top clientes por gasto (sumatorio `payment.amount`).

### 3. Estadística: promedio, varianza y desviación estándar
- Variabilidad (varianza muestral) del coste de reemplazo: `var_samp(replacement_cost)`.
- Métricas en pagos: `AVG(amount)`, `STDDEV(amount)`, `VARIANCE(amount)`.

### 4. Subconsultas encadenadas (resolución por etapas)
- Actores de una película concreta (p.ej. `EGG IGBY`) con cadena `film → film_actor → actor`.
- “Películas alquiladas por encima del importe medio” con cadena:
  `payment (amount) → rental (inventory_id) → inventory (film_id) → film (title)`.

### 5. Joins (INNER / LEFT) y verificación de cobertura
- Join de `inventory → film → rental` para detalle de alquileres.
- Detección de películas sin actor asociado (3 películas sin `film_actor`).

### 6. CTEs y tablas temporales
- CTE para conteo de películas por actor y filtrado `> 40`.
- CTE para disponibilidad por película en inventario por tienda.
- TEMP TABLE para resultados intermedios y reutilizables (p.ej. `clientes_gasto`, `pelis_actores`, `actor_categoria`, `cliente_rentas_temporal`, etc.).

### 7. Vistas (VIEW)
- Vista con “actor + número de películas” (`Numero_pelis_view`) para consultas repetibles.

### 8. Fechas/tiempos (timestamp/interval)
- Duración del alquiler: `return_date - rental_date` (interval) y promedio de duración.
- Conteos por mes con `EXTRACT(MONTH FROM rental_date)`.

### 9. Cambios de esquema (DDL)
- Renombrado de columnas en `actor`: `first_name → "Nombre"`, `last_name → "Apellido"`.
- En `rental`: creación de columna `dias_alquilada interval` y actualización con diferencias de timestamps.

---

## 4) Informe de análisis (qué se concluye del trabajo)

### Cobertura técnica alcanzada
- Consultas de lectura, alias, `DISTINCT`.
- `WHERE` con `AND/OR`, `LIKE`, `IN/NOT IN`.
- `ORDER BY`, `LIMIT`, `OFFSET`.
- Agregaciones y agrupaciones.
- Subconsultas de una y varias capas.
- `INNER JOIN`, `LEFT JOIN`, `CROSS JOIN` (y reflexión sobre su utilidad).
- CTEs para legibilidad y mantenimiento.
- TEMP TABLE para persistencia en sesión.
- VIEW para reutilización a largo plazo.
- Cálculo de intervalos y extracción de mes.
- Estadística agregada (promedio/varianza/desviación).

### Hallazgos anotados en el propio trabajo
- `film.original_language_id` está **NULL** en todos los registros (la consulta de coincidencia con `language_id` no aporta resultados).
- No aparece cliente con nombre `TAMMY` en los datos (consulta devuelve vacío).
- No se detectan clientes “sin alquileres” según los checks realizados.
- Existen 3 películas sin actor asociado en `film_actor`.

---

## 5) Incidencias detectadas y mejoras sugeridas (alineación con enunciados)
1) **“Antepenúltimo” vs OFFSET**: `LIMIT 1 OFFSET 1` devuelve el **penúltimo**; el antepenúltimo sería `OFFSET 2` (siempre con `ORDER BY`).
2) **Exclusión de ratings**: el enunciado cita `NC-17` y `G`, pero se filtró `PG-13` y `G` (ajustar `NOT IN`).
3) **Comedia y duración > 180**: falta el filtro de duración en la query de comedias (añadir `AND f.length > 180`).
4) **“Promedio por categoría > 110”**: se filtró por duración de película; lo correcto es `GROUP BY category` + `HAVING AVG(length) > 110`.
5) **Joins tras LEFT JOIN**: al unir después con `JOIN actor` se pierden filas con `actor_id NULL`; para “incluir películas sin actores” conviene `LEFT JOIN actor`.
6) **Películas alquiladas >= 10 veces**: se usó `LIMIT 10` (top 10) en lugar de `HAVING COUNT(*) >= 10`.
7) **Consulta de “no han actuado en Music”**: `c.name <> 'Music'` no garantiza “nunca Music”; conviene `NOT EXISTS` contra esa categoría.
8) **Categoría Animation**: “Animation” es nombre de categoría, no título de película; conviene partir de `category.name='Animation'`.

---

## 6) Objetos creados/modificados (inventario)
### Persistentes
- Vistas: `Numero_pelis_view` (y otras si se ejecutaron).
### Temporales (por sesión)
- `pelis_actores`, `clientes_gasto`, `rental_customer`, `actor_categoria`, `cliente_rentas_temporal`,
  `peliculas_alquiladas`, `total_alquileres`, `spartacus_first`, etc.
### Cambios de esquema
- Tabla `actor`: renombrado de columnas a `"Nombre"` y `"Apellido"`.
- Tabla `rental`: nueva columna `dias_alquilada interval` y carga con `UPDATE`.
